<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebUSB RTL-SDR Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        button {
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
        }
        #log {
            background: #000;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { color: #ff4444; }
        .success { color: #44ff88; }
        .info { color: #4488ff; }
    </style>
</head>
<body>
    <h1>ðŸ”§ WebUSB RTL-SDR Debug Test</h1>
    
    <p>This page tests WebUSB connectivity step by step.</p>
    
    <button id="testWebUSB">1. Test WebUSB Support</button>
    <button id="testRaw">2. Test Raw WebUSB</button>
    <button id="testLibrary">3. Test Library Import</button>
    <button id="testConnect">4. Test Full Connection</button>
    <button id="clearLog">Clear Log</button>
    
    <div id="log"></div>

    <script type="module">
        const logDiv = document.getElementById('log');
        
        function log(msg, type = '') {
            const time = new Date().toLocaleTimeString();
            const span = document.createElement('span');
            span.className = type;
            span.textContent = `[${time}] ${msg}\n`;
            logDiv.appendChild(span);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(msg);
        }
        
        // Test 1: Basic WebUSB support
        document.getElementById('testWebUSB').addEventListener('click', () => {
            log('--- Testing WebUSB Support ---', 'info');
            
            if (!navigator.usb) {
                log('âŒ navigator.usb is NOT available', 'error');
                log('WebUSB requires Chrome/Edge and HTTPS', 'error');
                return;
            }
            
            log('âœ… navigator.usb is available', 'success');
            log(`Protocol: ${location.protocol}`, 'info');
            log(`Host: ${location.host}`, 'info');
            log(`User Agent: ${navigator.userAgent}`, 'info');
        });
        
        // Test 2: Raw WebUSB request (no library)
        document.getElementById('testRaw').addEventListener('click', async () => {
            log('--- Testing Raw WebUSB Request ---', 'info');
            
            if (!navigator.usb) {
                log('âŒ WebUSB not supported', 'error');
                return;
            }
            
            try {
                log('Calling navigator.usb.requestDevice()...', 'info');
                const device = await navigator.usb.requestDevice({
                    filters: [
                        { vendorId: 0x0bda, productId: 0x2832 },
                        { vendorId: 0x0bda, productId: 0x2838 }
                    ]
                });
                log(`âœ… Device selected: ${device.productName}`, 'success');
                log(`Vendor ID: 0x${device.vendorId.toString(16)}`, 'info');
                log(`Product ID: 0x${device.productId.toString(16)}`, 'info');
            } catch (err) {
                if (err.name === 'NotFoundError') {
                    log('âš ï¸ No device selected (user cancelled or no device)', 'error');
                } else {
                    log(`âŒ Error: ${err.name}: ${err.message}`, 'error');
                }
            }
        });
        
        // Test 3: Library import
        document.getElementById('testLibrary').addEventListener('click', async () => {
            log('--- Testing Library Import ---', 'info');
            
            // Try different CDNs
            const cdns = [
                { name: 'esm.sh', url: 'https://esm.sh/@jtarrio/webrtlsdr@0.4.1/rtlsdr.js' },
                { name: 'jsdelivr', url: 'https://cdn.jsdelivr.net/npm/@jtarrio/webrtlsdr@0.4.1/+esm' },
                { name: 'skypack', url: 'https://cdn.skypack.dev/@jtarrio/webrtlsdr@0.4.1' }
            ];
            
            for (const cdn of cdns) {
                log(`Trying ${cdn.name}: ${cdn.url}`, 'info');
                try {
                    const module = await import(cdn.url);
                    log(`âœ… ${cdn.name} loaded successfully!`, 'success');
                    log(`Exports: ${Object.keys(module).join(', ')}`, 'info');
                    
                    if (module.RTL2832U_Provider) {
                        log('âœ… RTL2832U_Provider found', 'success');
                        window.workingCDN = cdn.url;
                        window.RTL2832U_Provider = module.RTL2832U_Provider;
                        return;
                    }
                } catch (err) {
                    log(`âŒ ${cdn.name} failed: ${err.message}`, 'error');
                }
            }
            
            log('âŒ All CDNs failed', 'error');
        });
        
        // Test 4: Full connection with library
        document.getElementById('testConnect').addEventListener('click', async () => {
            log('--- Testing Full Connection ---', 'info');
            
            if (!window.RTL2832U_Provider) {
                log('âŒ Library not loaded. Run Test 3 first.', 'error');
                return;
            }
            
            try {
                log('Creating RTL2832U_Provider...', 'info');
                const provider = new window.RTL2832U_Provider();
                
                log('Calling provider.get()...', 'info');
                const device = await provider.get();
                
                log('âœ… Device connected!', 'success');
                
                log('Testing setSampleRate(2400000)...', 'info');
                await device.setSampleRate(2400000);
                log('âœ… Sample rate set', 'success');
                
                log('Testing setCenterFrequency(100000000)...', 'info');
                await device.setCenterFrequency(100000000);
                log('âœ… Frequency set to 100 MHz', 'success');
                
                log('Testing readSamples(1024)...', 'info');
                const samples = await device.readSamples(1024);
                log(`âœ… Read ${samples.length} bytes`, 'success');
                
                log('Closing device...', 'info');
                await device.close();
                log('âœ… Device closed', 'success');
                
            } catch (err) {
                log(`âŒ Error: ${err.name}: ${err.message}`, 'error');
                console.error(err);
            }
        });
        
        // Clear log
        document.getElementById('clearLog').addEventListener('click', () => {
            logDiv.innerHTML = '';
        });
        
        // Initial log
        log('Debug page loaded', 'info');
        log(`URL: ${location.href}`, 'info');
    </script>
</body>
</html>
